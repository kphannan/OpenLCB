<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title>Standard Interactions</title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="824.48">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 16.0px 0.0px; font: 24.0px Times}
    p.p2 {margin: 0.0px 0.0px 12.0px 37.0px; font: 12.0px Times}
    p.p3 {margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times}
    p.p4 {margin: 0.0px 0.0px 12.0px 38.0px; font: 12.0px Times}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times}
    p.p6 {margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times}
    span.s1 {text-decoration: underline ; color: #0000f0}
  </style>
</head>
<body>
<h1 style="margin: 0.0px 0.0px 16.0px 0.0px; font: 24.0px Times"><b>Producer/Consumer Event Transfer</b></h1>
<p class="p2">OpenLCB nodes interact to control the layout via the reporting and observation of "events".</p>
<p class="p2">The protocol used to transfer these events is described here. It is built on top of the standard interactions and messages.</p>
<h2 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times"><b>Event Transfer</b></h2>
<p class="p4">OpenLCB nodes respond to local inputs and state changes by emitting Producer/Consumer Event Report (PCER) messages. When they do this, they are acting as "Producers". OpenLCB nodes receive these messages, and can act on them locally if desired. If they do so, they are acting as "Consumers".</p>
<p class="p4">The P/C Event ID included in a PCER message is a 8-byte unique identifier. The method for assigning these and ensuring their uniqueness is <a href="file:///Users/dpharris/openlcb/trunk/documents/EventIdUniqueAssignment.html"><span class="s1">specified elsewhere</span></a>.</p>
<p class="p4">There are many possible ways to use these 64 bits, some of which are discussed as examples below. In particular, OpenLCB does not require or enforce any particular partitioning of the eight bytes. More than one node may emit the same P/C Event ID (note that the NID of the emitting node is available in the message). More than one node may receive and act on a PCER message with a specific P/C Event ID. The only requirement is that the 8-byte quantity be unique to the event.</p>
<h2 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times"><b>Consumer Identification</b></h2>
<p class="p2">It is useful to be able to determine which, if any, nodes are listening for a specific P/C Event ID message.</p>
<p class="p2">This can be used as a configuration diagnostic, and as a way of building routing tables.</p>
<p class="p2">To determine which nodes are listening for a particular P/C Event ID, a node sends an Identify Consumers message carrying the desired P/C Event ID. This is an unaddressed message processed by all nodes.</p>
<p class="p2">All nodes that are listening for that P/C Event ID reply with a Consumer Identified broadcast message.</p>
<p class="p2">The "valid" bit indicates that the node is currently in the state it would be if this message had been received last. For example, assume a node sets its output active for P/C Event ID 2, and inactive for a P/C Event ID 4. Then if the output was active and the node was asked about P/C Event ID 2, it would reply "valid"; if asked about P/C Event ID 4, it would reply "not valid". Depending on the node's structure, it might not always be possible to set the "valid" bit with certainty, in which case the "unknown" bit must be set.</p>
<h2 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times"><b>Producer Identification</b></h2>
<p class="p2">It is useful to be able to determine which, if any, nodes are configured to possibly emit a specific P/C Event ID message and their current state.</p>
<p class="p2">This can be used as a configuration diagnostic, and as a way of building filtering and routing tables.</p>
<p class="p2">To determine which nodes can send a particular P/C Event ID, a node sends an Identify Producers message carrying the desired P/C Event ID. This is an unaddressed message addressed to all nodes.</p>
<p class="p2">All nodes that are listening for that P/C Event ID reply with a Producer Identified broadcast message.</p>
<p class="p2">The "valid" bit indicates that the node's internal condition is consistent with sending this P/C Event ID. For example, assume a node sends P/C Event ID 2 when the input goes active and P/C Event ID 4 when the input goes inactive. Then if the input was active and the node was asked about P/C Event ID 2, it would reply "valid"; if asked about P/C Event ID 4, it would reply "not valid". Depending on the node's structure, it might not always be possible to set the "valid" bit with certainty, in which case the "unknown" bit must be set.</p>
<h2 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times"><b>Event Identification</b></h2>
<p class="p2">It is useful to be able to rapidly determine which, if any, P/C Event IDs that a particular node is listening for and that it can emit.</p>
<p class="p2">This can be used as a configuration diagnostic.</p>
<p class="p2">To determine which P/C Event IDs can be send by a particular node, the inquiring node sends an Identify Events message addressed to the target node.</p>
<p class="p2">The node must reply with a Producer Identified message for each P/C Event ID it can produce, and a Consumer Identified message for each P/C Event ID for which it is listening.</p>
<h2 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times"><b>Initialization and Configuration Changes</b></h2>
<p class="p2">To ensure that event messages are properly routed, nodes must announce when they start to produce or consume messages. Specifically, they must do this at two times:</p>
<ol>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">When the node is first initialized and the "Initialization Complete" message has been sent.</li>
  <li style="margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times">When a configuration change has added an event ID that can be produced or consumed.</li>
</ol>
<p class="p2">To announce new Event IDs being consumed, the node must transmit a Producer Identified message for each P/C Event ID it can produce, and a Consumer Identified message for each P/C Event ID for which it is listening.</p>
<p class="p6"><i>This is SVN $Revision: 58 $</i></p>
</body>
</html>
