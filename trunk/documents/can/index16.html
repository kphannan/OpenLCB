<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title>NMRAnet: CAN Wire Protocol</title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="824.48">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 16.0px 0.0px; font: 24.0px Times}
    p.p2 {margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times}
    p.p4 {margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times}
    p.p5 {margin: 0.0px 0.0px 12.0px 0.0px; text-align: center; font: 12.0px Times}
    p.p6 {margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Lucida Grande}
    p.p7 {margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times; min-height: 14.0px}
    p.p8 {margin: 0.0px 0.0px 14.0px 0.0px; font: 14.0px Times}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times; min-height: 14.0px}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Lucida Grande; min-height: 15.0px}
    p.p11 {margin: 0.0px 0.0px 6.0px 0.0px; font: 12.0px Times; min-height: 14.0px}
    span.s1 {text-decoration: underline ; color: #0000f0}
    table.t1 {width: 767.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080}
    table.t2 {width: 658.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080}
    td.td1 {width: 177.0px; margin: 2.0px 2.0px 2.0px 2.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 8.0px 8.0px 8.0px 8.0px}
    td.td2 {width: 176.0px; margin: 2.0px 2.0px 2.0px 2.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 8.0px 8.0px 8.0px 8.0px}
    td.td3 {width: 315.0px; margin: 2.0px 2.0px 2.0px 2.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 4.0px 4.0px 4.0px 4.0px}
    td.td4 {width: 319.0px; margin: 2.0px 2.0px 2.0px 2.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 4.0px 4.0px 4.0px 4.0px}
    td.td5 {width: 240.0px; margin: 2.0px 2.0px 2.0px 2.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 8.0px 8.0px 8.0px 8.0px}
    td.td6 {width: 241.0px; margin: 2.0px 2.0px 2.0px 2.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 8.0px 8.0px 8.0px 8.0px}
    td.td7 {width: 268.0px; margin: 2.0px 2.0px 2.0px 2.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 8.0px 8.0px 8.0px 8.0px}
    td.td8 {width: 231.0px; margin: 2.0px 2.0px 2.0px 2.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 8.0px 8.0px 8.0px 8.0px}
    td.td9 {width: 222.0px; margin: 2.0px 2.0px 2.0px 2.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #808080 #808080 #808080 #808080; padding: 8.0px 8.0px 8.0px 8.0px}
  </style>
</head>
<body>
<h1 style="margin: 0.0px 0.0px 16.0px 0.0px; font: 24.0px Times"><b>CAN Wire Protocol</b></h1>
<p class="p2">CAN bus (ISO 11989-*) provides a very convenient transport medium for OpenLCB on a specific module or layout. This section defines a specific wire protocol for transporting OpenLCB over CAN bus.</p>
<p class="p2">Common OpenLCB messages need to be translated for transport via CAN 2.0B frames because of the limited CAN frame sizes and to take advantage of CAN interface features such as filtering on the header bits.</p>
<p class="p2">The adaptations include</p>
<ul>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">A 1-bit priority field has been added to provide a coarse high/low message priority</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">NID values are translated to 16 bit forms. Those forms are dynamically allocated so as to remain unique.</li>
  <li style="margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times">Remapping of MTI values to make limited filtering possible.</li>
</ul>
<p class="p2">Note that these adaptions must be possible in standard CAN components, e.g. bridges and computer adapters must not require customization to operate with OpenLCB. This provides a stringent requirement on protocol design, in that OpenLCB CAN cannot require specific timing, deliberate creation of error cases or specific error handling.</p>
<h2 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times"><b>Physical Layer</b></h2>
<p class="p2">Reference e.g. ISO 11898-2:2003</p>
<p class="p2">Rate is chosen to be 125kbps to balance length and loading (See the <a href="file:///Users/dpharris/openlcb/trunk/documents/can/Background.html"><span class="s1">CAN background document</span></a>)</p>
<p class="p2">Decisions to document (both decision and rationale):</p>
<ul>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Connector(s) &amp; cabling?</li>
</ul>
<ul>
  <ul>
    <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Full-length runs require twisted pairs. Polarity matters.</li>
    <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Flat telephone cable isn't twisted, and can be either cross-over or straight-through (much confusion due to different requirements of different DCC vendors); not a good idea to use it.</li>
    <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">LEDuino has a 4 pin header, carrying +5V, CanH, CanL, Ground.</li>
    <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">CBUS uses a wiring recommendation, instead of specifying a connector. The current CBUS cards use a captive-screw connector, allowing connection of CANH/CANL, ground, and several different power voltages. A recommendation is emerging to use the center pair of CAT5 cable (blue for CANH, white/blue for CANL).</li>
  </ul>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Termination provision requirements (every node has to have option to terminate in some way? switch? Queryable?)</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">The rise/fall time of CAN signals is a controllable parameter. The MCP2551 transceiver part used in e.g. MERG CBUS controls this with an Rs external resistor, by default a zero-Ohm jumper. According to Figure 1-1 of the MCP2551 datasheet, this corresponds to a slope of above 25V/usec. Mike Bolton recommended in September 2009 that future designs use a 100k resistor instead to give a better waveform shape at 125kbps by limiting the slope to just under 5V/usec.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Ground and possibly power provision(s)</li>
  <ul>
    <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Have to either require a common system ground, or provide for isolation of some sort. Isolation circuits much easier if there's an isolated power feed on the CAN side, e.g. in the cable. Are there simple CAN isolator circuits? At 125kbps, without losing timing margin and hence length?</li>
  </ul>
</ul>
<h2 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times"><b>Link Layer</b></h2>
<p class="p2">OpenLCB common messages are converted, to the extent possible, to single CAN frames via a one-to-one mapping.</p>
<p class="p2">The translations include:</p>
<ul>
  <li style="margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times">The NID Source ID (SID) is mapped to a shorter form, called a "NID Alias" (NIDa). The method for this mapping is defined such that devices on the CAN segment (e.g. gateways to other parts of the larger OpenLCB installation) can determine the full NID that corresponds to a particular alias.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Because this alias is still unique on the specific CAN segment, it is used in the CAN header for arbitration.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">MTIs may have to be shortened, depending on bit allocations.</li>
  <li style="margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times">When possible, Destination NIDs are also mapped to the shorter form. In some OpenLCB messages, this is not possible, in which case the full NID form is sent; a bit is provided to indicate which format is carried.</li>
</ul>
<p class="p2">Decisions to document:</p>
<ul>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">How to truncate/map the MTI to a smaller size. Common form is 16 bits to have lots of space to grow at the high end, but only 8 are really needed so far. Try to allocate on nibble boundaries to make dumps easy to read.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Nodes must handle full rate messages, specifically including messages not addressed to them. (The datagram and stream protocols provide ways for nodes to indicate whether or not they have sufficient buffering for the next transmission, triggering retries as needed)</li>
  <li style="margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times">A 1-bit field priority field coarsely specifies the priority of the message in terms of CAN arbitration to be high (pri=0) or low (pri=1). By default, all messages are to be emitted with low priority selected. Receiving nodes must not check this bit.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">This field is intended for network infrastructure and server type nodes (Command Stations) that may from time to time experience high traffic loads and need the ability to pre-empt other nodes to forward messages from a busy segment or preempt the sending of responses to nodes over receiving new requests to prevent message buffer overflow.</li>
  <li style="margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times">Filtering recommendations: in particular, find a way to set MTI bits to make filtering effective.</li>
</ul>
<p class="p2">Document header content and sizes (Nominal decisions shown, 29 bit header):</p>
<ul>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Priority bit (Always sent as 1 now; at front to ensure it acts like a true priority; 0 for high priority, 1 for low; not checked by receivers)</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Frame Type (1 bit) OpenLCB message or CAN control message</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Variable Field (11 bits)</li>
  <li style="margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times">Source NID alias (16 bits)</li>
</ul>
<p class="p2">(order is set to get proper priority and access disambiguation)</p>
<table width="767.0" cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="top" class="td1">
        <p class="p5"><b>Bit 0</b></p>
      </td>
      <td valign="top" class="td1">
        <p class="p5"><b>Bits 1</b></p>
      </td>
      <td valign="top" class="td1">
        <p class="p5"><b>Bits 2-12</b></p>
      </td>
      <td valign="top" class="td2">
        <p class="p5"><b>Bits 13-28</b></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td1">
        <p class="p5">Priority: 0 high, 1 low</p>
      </td>
      <td valign="top" class="td1">
        <p class="p5">Frame Type</p>
        <p class="p5">1: OpenLCB Message</p>
        <p class="p5">0: CAN Control Message</p>
      </td>
      <td valign="top" class="td1">
        <p class="p5">Variable Field</p>
      </td>
      <td valign="top" class="td2">
        <p class="p2">Source NID Alias</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p6"><br>
</p>
<p class="p3">The "Variable field" has different meanings depending on the "Frame Type" field. For CAN control messages, with the Frame Type bit is 0, to ensure high priority</p>
<table width="658.0" cellspacing="0" cellpadding="0" class="t2">
  <tbody>
    <tr>
      <td valign="middle" class="td3">
        <p class="p5"><b>Name</b></p>
      </td>
      <td valign="middle" class="td4">
        <p class="p5"><b>Variable Field</b></p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td3">
        <p class="p2">Check ID (CIM) message</p>
      </td>
      <td valign="middle" class="td4">
        <p class="p2">MMMNNNNNNNN where MMM is 0-5</p>
        <p class="p2">MMM is the message sequence number</p>
        <p class="p2">NNNNNNNN is the Node ID byte being checked</p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td3">
        <p class="p2">Reserved ID (RIM) Message</p>
      </td>
      <td valign="middle" class="td4">
        <p class="p2">0x7FF</p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td3">
        <p class="p2">Mapping Reset (MR) Message</p>
      </td>
      <td valign="middle" class="td4">
        <p class="p2">0x7FE</p>
      </td>
    </tr>
    <tr>
      <td valign="middle" class="td3">
        <p class="p2">Reserved</p>
      </td>
      <td valign="middle" class="td4">
        <p class="p2">0x6xx and 0x7xx up to 0x7FE</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p6"><br>
</p>
<p class="p2">For OpenLCB messages, the variable field is:</p>
<table width="767.0" cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="top" class="td5">
        <p class="p5"><b>Bits 0-6</b></p>
        <p class="p5"><b>(Bits 2-8 of CAN Header)</b></p>
      </td>
      <td valign="top" class="td5">
        <p class="p5"><b>Bits 7-9</b></p>
        <p class="p5"><b>(Bits 9-11 of CAN Header)</b></p>
      </td>
      <td valign="top" class="td6">
        <p class="p5"><b>Bit 10</b></p>
        <p class="p5"><b>(Bit 12 of CAN Header)</b></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">MTI Value</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">Reserved as 1</p>
      </td>
      <td valign="top" class="td6">
        <p class="p2">0: Dest ID is an alias</p>
        <p class="p2">1: Dest ID is full length</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p6"><br>
</p>
<p class="p2">The specific MTI values are</p>
<table width="767.0" cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="top" class="td5">
        <p class="p5"><b>MTI</b></p>
      </td>
      <td valign="top" class="td5">
        <p class="p5"><b>CAN Value</b></p>
      </td>
      <td valign="top" class="td6">
        <p class="p5"><b>Notes</b></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">Initialization Complete</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">0x33</p>
      </td>
      <td valign="top" class="td6">
        <p class="p7"><br></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">PC Event Report</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">0x34</p>
      </td>
      <td valign="top" class="td6">
        <p class="p7"><br></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">Verify Node ID</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">0x35</p>
      </td>
      <td valign="top" class="td6">
        <p class="p7"><br></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">Verified Node ID</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">0x36</p>
      </td>
      <td valign="top" class="td6">
        <p class="p7"><br></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">Identify Consumers</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">0x37</p>
      </td>
      <td valign="top" class="td6">
        <p class="p7"><br></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">Consumer Identified</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">0x38</p>
      </td>
      <td valign="top" class="td6">
        <p class="p7"><br></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">Identify Producers</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">0x39</p>
      </td>
      <td valign="top" class="td6">
        <p class="p7"><br></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">Producer Identified</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">0x3A</p>
      </td>
      <td valign="top" class="td6">
        <p class="p7"><br></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">Identify Events</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">0x3B</p>
      </td>
      <td valign="top" class="td6">
        <p class="p7"><br></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">Verify Node</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">0x3C</p>
      </td>
      <td valign="top" class="td6">
        <p class="p7"><br></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">Verified Node</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">0x3D</p>
      </td>
      <td valign="top" class="td6">
        <p class="p7"><br></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">Consumer Identify Range</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">0x3E</p>
      </td>
      <td valign="top" class="td6">
        <p class="p7"><br></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p2">Producer Identify Range</p>
      </td>
      <td valign="top" class="td5">
        <p class="p2">0x3F</p>
      </td>
      <td valign="top" class="td6">
        <p class="p7"><br></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td5">
        <p class="p7"><br></p>
      </td>
      <td valign="top" class="td5">
        <p class="p7"><br></p>
      </td>
      <td valign="top" class="td6">
        <p class="p2">All others reserved</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p6"><br>
</p>
<p class="p2"><i>Document no-seven-1-bits-in-top limitation.</i></p>
<h2 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times"><b>CAN-specific messages and interactions</b></h2>
<h3 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 14.0px Times"><b>CANid assignment</b></h3>
<p class="p2">The common message format uses full 48-bit node ID numbers to identify originating nodes and in some case destination nodes. CAN frames use 16-bit local "NID alias" for these to save space in the limited-size CAN payload.</p>
<p class="p2">The standard Verify Node ID Number interaction can be used to get the full 48-bit NID from a node for translation. At power up each node must obtain a alias that is locally unique. Gateways will also have to obtain unique aliases for remote nodes they are proxying on to the segment.</p>
<p class="p2">Proposed algorithm, in rough form:</p>
<ul>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Compute a CANid from the NID using a standard algorithm.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Send CAN frames claiming that CANid and carrying sequential parts of NID in the Variable Field section of the header.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">If error, step the algorithm in a standard way and repeat until success.</li>
  <li style="margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times">Send a CAN frame announcing that the node has claimed an ID value.</li>
</ul>
<p class="p2">Note that there is no requirement that this alias be consistent from one run to the next. More detail is on a <a href="file:///Users/dpharris/openlcb/trunk/documents/can/CanIDAllocation.html"><span class="s1">separate page</span></a>.</p>
<h3 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 14.0px Times"><b>CAN-specific messages</b></h3>
<p class="p2">Most CAN frames are one-to-one equivalents of common OpenLCB messages.</p>
<p class="p2">A few additional messages are used for CAN-specific purposes.</p>
<p class="p3">CIM</p>
<p class="p3">Check ID Message - used as part of the <a href="file:///Users/dpharris/openlcb/trunk/documents/can/CanIDAllocation.html"><span class="s1">ID allocation</span></a>.</p>
<p class="p3">RIM</p>
<p class="p3">Reserved ID Message - used as part of the <a href="file:///Users/dpharris/openlcb/trunk/documents/can/CanIDAllocation.html"><span class="s1">ID allocation</span></a>.</p>
<p class="p3">MR</p>
<p class="p3">Mapping Reset - indicates that the local alias in the source address field may no longer be associated with the same NID, and mapping tables should be reset.</p>
<h2 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times"><b>Translation</b></h2>
<p class="p2">A node must be able to convert traffic on the local CAN segment into the common message format using only locally available information. This may be needed e.g. by a gateway or monitoring program attached to the CAN segment.</p>
<p class="p2">All traffic on a CAN segment uses aliases for both Source ID (always) and Destination ID (when the full NID isn't known).</p>
<p class="p2">If/when a full NID is needed, it can be obtained by sending a "Verify Node ID Number (Addressed)" message with an appropriate Destination Node ID in local alias form. The reply will eventually come back with the Source ID in local alias form and carrying the full NID in the message content.</p>
<p class="p2">Aliases for nodes on the local segment are only valid until an "Initialization Complete" is seen from that alias. Initialization Complete flags that a node has restarted, and may have another local alias.</p>
<p class="p2">Gateways maintain the mapping between remote node's NID and local alias. If they need to break that mapping, e.g. because they need to reuse the local alias due to resource limitations in the mapping tables, they must send a "Mapping Reset" message to force nodes to drop their alias information. <i>"Mapping Reset" is a CAN-specific message limited to the segment, but all gateways on the segment must act on it.</i></p>
<p class="p2">Gateways may not be able ensure permanent validity for alias to remote NIDs. For example, if they have a limited routing table, they may need to reuse local alias. Before reusing them, they have to send a "Mapping Reset" frame to drop references to the old NID, followed by a "Initialization Complete" when the alias is allocated to a new NID.</p>
<h3 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 14.0px Times"><b>Map Acquisition</b></h3>
<p class="p2">In order to acquire the map between CANids and NIDs, a gateway needs to be able to send a CAN frame requiring "everybody reply with your NID". Much like Ethernet gateway mapping, this needs to return the NID of just the specific CAN-attached hardware, not all the NIDs that can be e.g. reached through a gateway, so it needs to be a segment-specific message defined only at the CAN level. It must not be a OpenLCB common message.</p>
<h2 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times"><b>OpenLCB message format</b></h2>
<p class="p2">OpenLCB common messages are carried in frames with a specific value of the Frame Type field. They contain message type information in the 10-bit variable field, and zero to eight CAN data bytes.</p>
<p class="p9"><br></p>
<table width="767.0" cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="top" class="td7">
        <p class="p5"><b>Bit (5 bits?)</b></p>
      </td>
      <td valign="top" class="td8">
        <p class="p5"><b>Bit (4 bits)</b></p>
      </td>
      <td valign="top" class="td9">
        <p class="p5"><b>Bit 9</b></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td7">
        <p class="p5">Message Type Code</p>
      </td>
      <td valign="top" class="td8">
        <p class="p5">Expansion Field (must be 1's) and status bits</p>
      </td>
      <td valign="top" class="td9">
        <p class="p2">0 – no DestinationID present</p>
        <p class="p2">1 – DestinationID at start of data</p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p6"><br>
</p>
<p class="p10"><br></p>
<p class="p3"><i>Need 2 status bits with “Consumer Identified”, in addition to the EventID that's filling the data segment.</i></p>
<p class="p9"><br></p>
<p class="p3"><i>Do we need a way to say full/alias form of destination ID?</i></p>
<p class="p9"><br></p>
<p class="p3">Coding of message types is similar to in the common format MTI. Be nice if that also coded up e.g. EventID present....</p>
<p class="p9"><br></p>
<p class="p3">(Assignment table)</p>
<p class="p9"><br></p>
<p class="p11"><br></p>
<p class="p2">This is SVN $Revision: 83 $</p>
</body>
</html>
