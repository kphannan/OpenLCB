<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title>NMRAnet Overview</title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="824.48">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 16.0px 0.0px; font: 24.0px Times}
    p.p2 {margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times}
    p.p3 {margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times}
    p.p5 {margin: 0.0px 0.0px 14.0px 0.0px; font: 14.0px Times}
    p.p6 {margin: 0.0px 0.0px 6.0px 0.0px; font: 12.0px Times; min-height: 14.0px}
    span.s1 {text-decoration: underline ; color: #0000f0}
  </style>
</head>
<body>
<h1 style="margin: 0.0px 0.0px 16.0px 0.0px; font: 24.0px Times"><b>Overview</b></h1>
<h2 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times"><b>Introduction</b></h2>
<p class="p3">OpenLCB defines a family of interoperating protocols for controlling model railroads. It is structured around some common concepts and separate implementations.</p>
<p class="p3">The OpenLCB will be capable of supporting Accessory Control, Advanced Locomotive Control and even Multimedia and Rich Text features on the higher bandwidth networks. This protocol proposal will focus on OpenLCB Accessory Control with emphasis on CAN 2.0B but allowance has to be made for simple Locomotive Control and implementation of the OpenLCB protocol on other network technologies like Ethernet, Internet and others.</p>
<p class="p3">This proposal is based on a series of <a href="file:///Users/dpharris/openlcb/trunk/documents/UseCases.html"><span class="s1">use cases</span></a> that extend from a beginning modeller connecting up two boards to a huge modular layout put together by several clubs. To achieve this range, and to allow for future technologies, OpenLCB is defined so that it can communicate over CAN segments, within computers, and on network links.</p>
<h2 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 18.0px Times"><b>Key Features of This OpenLCB Protocol Proposal</b></h2>
<p class="p3">The key features of this proposal are:</p>
<ul>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">The basic communicating unit is called a "Node". A node might be a single board, or a single program in a PC, or any other addressable item. A node may control any number of actual devices on a layout. Nodes exchange messages to control the layout.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">At it's basic level, OpenLCB defines a transport layer for several types of data:</li>
  <ul>
    <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Events - Fixed length identifers that can propagate from multiple source nodes to multiple destination nodes.</li>
    <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Streams - An efficient way to move a large, variable number of bytes from one node to another.</li>
  </ul>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">This transport level also has provision for interconnection of independent OpenLCB segments and filtering of messages to reduce traffic.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">OpenLCB defines a global set of common message types and their content. OpenLCB specifies how the common message types are to be used for standard interactions and optional interactions. All OpenLCB nodes must be able to properly take part in standard interactions that are originated from outside the node.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">The format of the common messages is separately specified for each of several wire protocols. The initial wire protocols are CAN and TCP/IP point-to-point; additional ones are envisaged. OpenLCB wire protocols may define additional interactions and messages for specific transport-level uses, e.g. for housekeeping on the local connection. These interactions and messages will be divided into standard forms, which all nodes must implement, and optional forms.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">The OpenLCB as a whole is considered as being comprised of one or more OpenLCB segments interconnected with bridge devices that ensure all nodes are able to communicate equally with all other nodes on the OpenLCB.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Every node has a "Node ID number" (NID). The assignment of the NIDs assures they are globally unique.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">There is no hierarchy of nodes or node aggregation or tree structures or segmentation that necessarily filters OpenLCB traffic. The OpenLCB is a flat structure where all nodes are equally accessible and addressable. (There is provision for gateways to acquire routing information and filter; does that need to be mentioned here?)</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">All OpenLCB nodes can see all OpenLCB messages (subject to optional filtering, see above).</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">All OpenLCB nodes on all segments are uniquely identified by a Node ID number and use this Node ID in all OpenLCB messages as a Source Node ID.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Any OpenLCB message can be traced back to the originator using the Source Node ID.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Above the basic transport level, OpenLCB defines methods for</li>
  <ul>
    <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Event transfer for layout control</li>
    <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Node configuration</li>
  </ul>
  <li style="margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times">and others.</li>
</ul>
<h3 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 14.0px Times"><b>CAN items</b></h3>
<p class="p3"><i>(Section needs work)</i></p>
<ul>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">The Node ID is unique, but too large to carry in a CAN header. Therefore OpenLCB dynamically creates a seqment-unique "Node ID alias", which then provides the necessary uniqueness to the CAN Arbitration Header to ensure reliable collision avoidance. No other form of e.g. priority bits is required to assist with arbitration of messages with possibly ambiguous or non-unique CAN Header bit patterns.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Where a point to point or directed OpenLCB message needs to be sent to a specific node the Destination ID field is placed in the CAN Data portion of the CAN Frame. In most cases, this uses the shorter "alias" form.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">No central Network Manager is required, either globally or on a segment. Global network monitoring and diagnostics can be provided.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">CAN masks/filters can still be applied to stream data transfers as required the combination of TYPE + SRC_ID + STREAM_ID which are all in the CAN Header will uniquely identify an individual stream.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Event data is placed in the CAN Data portion of the CAN Frame.</li>
  <li style="margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times">Stream data can transfer up to 8?? bytes of data per CAN Frame and a single node can source up to 16?? different stream channels concurrently. <i>Pending implementation details...</i></li>
  <li style="margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times"><i>This item needs to be rethought.</i> The SRC_ID is sticky in that once a OpenLCB node is allocated a SRC_ID, it should be stored in such a way that it can be reused for subsequent OpenLCB sessions. For CAN segments (particularly throttles) it will probably mean storing the SRC_ID along with the lcb_id in local device EEPROM to that for each OpenLCB segment that the throttle connects to it can reuse it's previously allocated address.</li>
  <li style="margin: 0.0px 0.0px 12.0px 0.0px; font: 12.0px Times"><i>This part needs to be rethought.</i> Ethernet segments will hopefully have a DHCP server present as part of a internet broadband connection. These DHCP servers can usually be relied on to keep track of previous IP address leases based on the Ethernet MAC address and reissue the same IP address for subsequent IP address leases. For Ethernet nodes, the SRC_ID will be based on part of the IP address √ê probably the lower 1 or 2 bytes. This will be defined in the bridge(s) for that LCB/LCB_ID.</li>
</ul>
<h3 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 14.0px Times"><b>Design Considerations</b></h3>
<p class="p3">Networking technologies come and go and new ones become dominant. Due consideration needs to be given to the possibility that the current popular networking technologies of CAN and Ethernet may be eclipsed in the future by emerging technologies like Wireless 802.15.4, FlexRay and others. The OpenLCB protocol design should ensure that it will perform adequately on common CAN and Ethernet (including WiFi) networking technologies, but not at the expense of limiting its adaptation to other networking technologies, including ones not considered now.</p>
<p class="p3">A critical design consideration is to allow for the addition of newer technologies without having to discard the older technologies. OpenLCB must be able to seamlessly add new network segments without having to reconfigure the whole OpenLCB to accommodate the change. Node numbers, event IDs and similar things should be portable across the network so that topology changes are accommodated without requiring major reconfiguration.</p>
<p class="p3"><i>Paragraph needs to be reworked</i> The adaptation of the common OpenLCB protocol to CAN does not try to minimise CAN message sizes at the expense of mixing Transport and Application layer information. This proposal errs on the side of maintaining a clear separation between the Transport and Appliation layers to ensure ease of bridging, tunnelling and encapsulation in other networks and reducing the impact of protocol changes on network infrastructure devices like bridges, repeaters, network managers and monitoring tools.</p>
<p class="p3">A significant design consideration for the OpenLCB has to be ease of use for non-technical users and provision of Plug-N-Play type features including automatic discovery and user friendly configuration tools to assist with OpenLCB setup and configuration. Also OpenLCB needs to support gathering of network performance statistics to assist with performance tuning, identifying the cause(s) of faults and performance problems.</p>
<p class="p3">The OpenLCB must be able to start small and grow over time as layouts evolve.</p>
<h3 style="margin: 0.0px 0.0px 14.0px 0.0px; font: 14.0px Times"><b>OpenLCB Network Topology</b></h3>
<p class="p3">OpenLCB is built on top of a reliable transport. This can be either point-to-point, or multipoint. ‚ÄúReliable‚Äù transport delivers all messages between two nodes, without changes, deletions, duplications, additions or reorderings. No assumptions are made about the order of communications between different nodes or node pairs. (To allow for CAN network behavior, low priority messages may be delivered behind higher priority messages)</p>
<p class="p3">A layout with a OpenLCB will require at least one OpenLCB network segment. This could be CAN, Wireless, Ethernet or WiFi, but is likely a combination of several technologies. A layout may have a lengthy CAN based OpenLCB segment with many nodes running around the entire layout and have a comparatively short Ethernet segment or backbone segment that provides a convenient connection to a single PC. It is likely that entry level OpenLCB compatible DCC Command Stations will just have a CAN OpenLCB interface and a USB PC interface. Medium level DCC Command Stations might add Ethernet and Wireless interfaces whereas top end DCC Command Stations may also add WiFi. It is also likely that manufacturers will provide various interface devices to bridge between each of the OpenLCB segment types like CAN to Ethernet, CAN to USB (for PC access), CAN to Wireless and Ethernet to Wireless (for wireless throttles). Bridges to WiFi are likely to be using consumer grade Ethernet to WiFi Access Points but some markets may opt for a WiFi interface in the DCC Command Station.</p>
<p class="p3">Each segment of a OpenLCB is by default transparently connected to all other segments. A single CAN cable would be a OpenLCB segment, as would two CAN cables connected by a repeater. An Ethernet link would also be a segment, as would TCP/IP network connections.</p>
<p class="p3">Two or more segments can be connected by bridge devices. Simple bridge devices do not filter any messages: all messages are forwarded to all other segments. More intelligent interconnection devices can reduce required bandwidth by filtering messsages that are not needed on the far side of the bridge; these are called gateways.</p>
<p class="p3">As an example, a CAN segment with a number of nodes can be connected via a CAN-USB or CAN-Ethernet bridge to a PC running several seprate control programs.</p>
<p class="p4">As another example, a CAN segment in a series of modules can be connected via a bridge to an Ethernet backbone, which in turn connects via several other bridges to separate CAN segments in other collections of modules. Several PCs can be connected via the Ethernet and interact with all the modules via the individual CAN segments.</p>
<p class="p6"><br></p>
<p class="p3">This is SVN $Revision: 58 $</p>
</body>
</html>
