<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8">
	<TITLE>OpenLCB CAN Message Network Explanation</TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice.org 3.2  (Unix)">
	<META NAME="CREATED" CONTENT="0;0">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<META NAME="CHANGED" CONTENT="20100919;23031900">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<STYLE TYPE="text/css">
	<!--
		H2.ctl { font-family: "Lucida Sans" }
		H3.ctl { font-family: "Lucida Sans" }
	-->
	</STYLE>
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<H1><FONT COLOR="#000000"><IMG SRC="../web/logo-ajs-dph.png" NAME="OpenLCB" ALIGN=RIGHT WIDTH=337 HEIGHT=135 BORDER=2></FONT>OpenLCB
CAN Message Network Explanation</H1>
<P>So far, mostly parts from other documents....</P>
<H1><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="David Harris"><!-- $Id$ -->OpenLCB
Common Message Format</H1>
<P>A common message consists of several parts: 
</P>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">Node ID Number of the Source node
	(SID) 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">Message Type Indicator (MTI) 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">In some cases, the Destination
	Node ID (DID) 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">In some cases, a P/C Event ID
	(EID) 
	</P>
	<LI><P>Message content, as defined by the particular message type 
	</P>
</UL>
<P>Each OpenLCB wire protocol may define local representations for
each of these components at the transport level and below. This may
involve replacement (e.g. using a shorter &quot;Alias&quot; token for
the node ID number), reordering, and/or specific representations that
differ from the common ones, but in all cases it must be possible to
translate from the wire protocol message to a complete common message
using only locally available information. 
</P>
<P>By convention, multi-byte quantities in OpenLCB are represented in
big-endian order. The most significant byte is sent first, and stored
at the lowest address. This is the same as Ethernet and the common
internet protocols, but not the same as the Intel x86 architecture. 
</P>
<P>Reserved quantities must be created with a zero value unless
otherwise specified. When processing a message, any reserved
quantities must be ignored unless otherwise specified. When
transporting a message, reserved quantities must be transported
unchanged. The zero value sometimes indicates a non-initialized
value. 
</P>
<H2 CLASS="western">Node ID Numbers - NID</H2>
<P>A node ID number is 48 bits. The NMRA will allocate number ranges
to individuals or organizations upon request, and maintain a public
list of assignments. A detailed mechanism for kinds of delegation has
been <A HREF="../documents/NidUniqueAssignment.html">separately
proposed</A>. 
</P>
<H2 CLASS="western">Message Type Indicator (MTI)</H2>
<P>The common Message Type Indicator (MTI) is a 16 bit quantity. 
</P>
<P>Each specific MTI has a specific defined content <A HREF="../documents/CommonMessageDefinitions.html">documented
elsewhere</A>, but there are a few general points. 
</P>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">Messages are variable length. The
	specific wire protocol is responsible for carrying length
	information as needed. 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">If the message carries a
	destination address, that destination node ID (destination address)
	is the first part of the message content. The form of a Destination
	Node ID is defined by the particular wire protocol, but must be
	mappable to the full Node ID of the intended destination. 
	</P>
</UL>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P>The common Message Type Indicator (MTI) is a 16 bit quantity. Note
that specific wire protocols may remap this.</P>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">The most-significant 5 bits are
	reserved as 00110; nodes must send and check that value.</P>
	<LI><P STYLE="margin-bottom: 0cm">The next 7 bits are used to
	indicate the message type. 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">The top two of these are used to
	form static priority groups. A 0 bit is considered to have more
	priority (can be processed first), a 1 bit less priority (can be
	processed later). The MSB makes a larger statement about priority
	than the LSB of these two. Priority processing is permitted but not
	required. The priority group bits are part of the overall message
	type.</P>
	<LI><P STYLE="margin-bottom: 0cm">The next bit is reserved as 0;
	nodes must send and check that value.</P>
	<LI><P STYLE="margin-bottom: 0cm">The lower four bits indicate a
	specific type. 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">The following bit is reserved as
	0; nodes much send and check that value.</P>
	<LI><P STYLE="margin-bottom: 0cm">The 2<SUP>nd</SUP>
	from-least-significant bit indicates that this message carries a
	destination node address (DID) when set to 1. Setting 0 means that
	the message is globally addressed. If a Destination Node ID (DID) is
	present, it is located at the start of the message content. The form
	of a Destination Node ID is defined by the particular wire protocol,
	but must be mappable to the full NID of the intended destination. 
	</P>
	<LI><P>The next-to-least-significant bit indicates this message
	carries a P/C Event ID field when set to 1. Setting 0 means that the
	message does not carry a P/C event ID. If a P/C Event ID is present,
	it's at the start of the message, except after the Destination Node
	ID, if present. 
	</P>
	<LI><P>The least-significant bit when set to 1 indicates this
	message carries a flag byte after the DID and/or EID determined by
	the above bits. The low bits of that byte can be relocated in CAN
	messages, see the definition of the CAN wire protocol.</P>
</UL>
<P>We've chosen to allocate bit fields to make decoding simpler; if
possible, aligned on nibble boundaries to make it easy to read as
hexadecimal numbers. Note that, as a special dispensation for CAN,
higher priority messages (MTIs with lower numerical values) may pass
lower priority ones; this must be taken into account when designing
protocols.</P>
<P STYLE="margin-bottom: 0cm">Specific values are allocated and
documented in a <A HREF="../documents/MtiAllocations.ods">separate
worksheet</A> (<A HREF="../documents/MtiAllocations.pdf">PDF
version</A>). We keep them in just that one place to avoid
conflicting updates.</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<H1 STYLE="page-break-before: always"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="David Harris"><!-- $Id$ -->OpenLCB
Common Message Types</H1>
<P STYLE="margin-bottom: 0cm"><I>(Removed the datagram, stream, event
message sections)</I></P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm">The content listed here is in addition
to the originating NID, MTI and Destination Node ID, if any. The full
format is specified in a <A HREF="../documents/CommonMessageFormat.html">separate
note</A>.</P>
<P STYLE="margin-bottom: 0cm">Some messages may be either addressed
to a specific node, or globally addressed to all nodes. These are
indicated by separate MTI values (see below).</P>
<H2 CLASS="western">Base Messages</H2>
<H3 CLASS="western"><A NAME="ic"></A>Initialization Complete</H3>
<P STYLE="margin-bottom: 0cm; font-style: normal">Indicates that the
node is complete, and once the message is delivered, reachable on the
network.</P>
<P STYLE="margin-bottom: 0cm">Content:</P>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">NID of the sending node</P>
</UL>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm">Only Global (unaddressed) form
available.</P>
<H3 CLASS="western"><A NAME="vynid"></A>Verify Node ID</H3>
<P STYLE="margin-bottom: 0cm">Content: None 
</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm">Global (unaddressed) or with specified
destination address.</P>
<H3 CLASS="western"><A NAME="vrnid"></A>Verified Node ID</H3>
<P STYLE="margin-bottom: 0cm">Content:</P>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">NID of the sending node – this
	is sent in full 48 bit format in all wire protocols, even if an
	alternate form or alias is available elsewhere in the message</P>
</UL>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm">Only Global (unaddressed) form
available.</P>
<H3 CLASS="western"><A NAME="psi"></A>Protocol Support Inquiry</H3>
<P STYLE="margin-bottom: 0cm">Content: None</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm">Destination address required.</P>
<H3 CLASS="western"><A NAME="psr"></A>Protocol Support Reply</H3>
<P STYLE="margin-bottom: 0cm">Content: Bytes containing bits
identifying the available OpenLCB protocols; see definitions in
separate (<A HREF="../documents/ProtocolBitAllocations.ods">spreadsheet</A>)
(<A HREF="../documents/ProtocolBitAllocations.pdf">pdf</A>).</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm">Destination address required.</P>
<H3 CLASS="western"><A NAME="oir"></A>Optional Interaction Rejected</H3>
<P STYLE="margin-bottom: 0cm">Content:</P>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">Mandatory original MTI 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">Optional error code (TBD) 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">Optional data content (TBD)</P>
</UL>
<P STYLE="margin-bottom: 0cm">Destination address required.</P>
<H3 CLASS="western"><A NAME="tde"></A>Terminate Due to Error</H3>
<P STYLE="margin-bottom: 0cm">Content:</P>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">Mandatory most recent MTI 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">Mandatory error code (TBD) 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">Optional data content (TBD)</P>
</UL>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm">Destination address required.</P>
<H2 CLASS="western"><BR><BR>
</H2>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<H1 STYLE="page-break-before: always"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="Bob Jacobsen"><META NAME="CHANGEDBY" CONTENT="David Harris"><!-- $Id$ -->Standard
Interactions</H1>
<P STYLE="margin-bottom: 0cm">All nodes must be able to take part in
all standard interactions.</P>
<H2 CLASS="western">A) Node Initialization</H2>
<P STYLE="margin-bottom: 0cm">Newly functional nodes, once their
start-up is complete and they are fully operational, must send an
&quot;Initialization Complete&quot; message. 
</P>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">There is no guarantee that any
	other node is listening for this. No reply is possible. 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">Nodes must not emit any other
	OpenLCB message before the “Initialization Complete” message.</P>
</UL>
<P STYLE="margin-bottom: 0cm">Sending the IC message is required to
insure that higher-level tools are notified that they may start to
work with the node. 
</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm">After the IC message is sent, and
before any corresponding Producer/Consumer Event Report messages are
sent, the node must identify all events produced or consumed on the
board via zero or more Identify Consumers, Identify Consumed Range,
Identify Producers and Identify Consumed Range messages. These are
not required to be in any particular order. 
</P>
<H2 CLASS="western"><A NAME="discovery"></A>B) Duplicate Node ID
Detection</H2>
<P>OpenLCB nodes must have unique node IDs. To detect this across the
entire connected OpenLCB, all OpenLCB nodes must indicate an error if
they detect an incoming message with a Source Node ID equal to their
own. If possible, they should indicate it at the board itself using a
light or similar. If possible, they should emit a PCER message with
the “Duplicate Source ID detected” global event, which will carry
the duplicate event ID in the Source Node ID field. 
</P>
<P>After sending the “Duplicate Source ID detected” global event,
the node should not transmit any further messages until reset because
this message will be received at the other duplicate-ID node(s),
resulting in additional “Duplicate Source ID detected” global
events and causing a possible message loop.</P>
<P>To further improve the reliability of this detection, OpenLCB
nodes should, but need not, emit a Verified Node ID message every 30
to 90 seconds. As an implementation detail, it's recommended that
CAN-attached nodes use their NIDa to pick that interval so that
messages don't bunch up.</P>
<H2 CLASS="western">C) Node ID Discovery</H2>
<P STYLE="margin-bottom: 0cm">Upon receipt of a Verify Node ID Number
message addressed to it, or an unaddressed Verify Node ID Number
message, a node will reply with an unaddressed Verified Node ID
Number. 
</P>
<P STYLE="margin-bottom: 0cm">This can be used as check that a
specific node is still reachable. When wire protocols compress the
originating and/or destination NID, this can be used to obtain the
full NID. 
</P>
<H2 CLASS="western">D) Protocol Discovery</H2>
<P>OpenLCB defines a number of specific protocols for interacting
with nodes, including event exchange, datagrams, streams,
configuration, etc. These protocols are optional, in the sense that
not every node will implement every one. 
</P>
<P>To determine which protocols a node implements, a Protocol Support
Inquiry message is sent to the specific node. It will reply with a
Protocol Support Reply message that contains one or more bytes of
data. A specific bit position has been reserved for each defined
protocol in a separate spreadsheet (<A HREF="../documents/ProtocolBitAllocations.ods">.ods</A>,
<A HREF="../documents/ProtocolBitAllocations.pdf">.pdf</A> form). If
the bit is zero or not present, the protocol is not supported and
requests to use it will result in a error. If present and 1, the
protocol is supported.</P>
<P>It is not necessary to check whether a protocol is supported by a
node before attempting to use the protocol. If it's not, the error
handling mechanism (see below) will indicate that.</P>
<H2 CLASS="western">E) Error Handling</H2>
<P STYLE="margin-bottom: 0cm">There are multiple mandatory
error-handling scenarios defined.</P>
<H3 CLASS="western">Reject Addressed Optional Interaction</H3>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">Node A receives an addressed
	message from Node B that carries Node A's NID. 
	</P>
</UL>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">The MTI indicates the start of an
	optional interaction. 
	</P>
</UL>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">If Node A does not want to take
	part in the optional interaction, it may send an Optional
	Interaction Rejected message addressed to Node B with the original
	MTI in the message content. There is no requirement that OIR be
	sent; the node may silently ignore the incoming message.</P>
</UL>
<P STYLE="margin-bottom: 0cm">The message content also contains an
optional reason code and an optional data value. The use of these
fields is to be defined. 
</P>
<H3 CLASS="western">Reject Unaddressed Optional Interaction</H3>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">Node A receives an unaddressed
	message from Node B. 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">The MTI indicates the start of an
	optional interaction. 
	</P>
</UL>
<P STYLE="margin-bottom: 0cm">If Node A does not want to take part in
the optional interaction, it silently drops the message without
reply. 
</P>
<H3 CLASS="western">Reject Addressed Standard Interaction Due to
Error</H3>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">Node A is taking part in an
	addressed interaction with Node B. Either node may be able to send
	the next message.</P>
	<LI><P STYLE="margin-bottom: 0cm">Some error condition prevents Node
	A from continuing the interaction. 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">To terminate the interaction, Node
	A sends a Terminate Due to Error message to Node B. It then resets
	it's state so as to no longer be taking part in the addressed
	interaction.</P>
</UL>
<P STYLE="margin-bottom: 0cm">The message content contains the most
recent MTI received in this interaction, a mandatory reason code and
an optional data value. The use of these fields is to be defined. 
</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<HR>
<P>Site hosted by <FONT COLOR="#000080">
<A HREF="http://sourceforge.net/projects/openlcb"><FONT COLOR="#000080"><IMG SRC="http://sflogo.sourceforge.net/sflogo.php?group_id=286373&amp;type=13" NAME="graphics1" ALIGN=ABSMIDDLE WIDTH=120 HEIGHT=30 BORDER=2></FONT></A></FONT>
</P>
<P>This is SVN $Revision$ 
</P>
</BODY>
</HTML>