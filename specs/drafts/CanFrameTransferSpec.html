<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8">
	<TITLE>OpenLCB CAN Frame Transfer Specification</TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice.org 3.2  (Unix)">
	<META NAME="CREATED" CONTENT="0;0">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<META NAME="CHANGED" CONTENT="20101004;9391400">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<STYLE TYPE="text/css">
	<!--
		H2.ctl { font-family: "Lucida Sans" }
		H3.ctl { font-family: "Lucida Sans" }
		H4.ctl { font-family: "Lucida Sans" }
	-->
	</STYLE>
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<H1><FONT COLOR="#000000"><IMG SRC="../../web/logo-ajs-dph.png" NAME="OpenLCB" ALIGN=RIGHT WIDTH=337 HEIGHT=135 BORDER=2></FONT>OpenLCB
CAN Frame Transfer Specification</H1>
<H2 CLASS="western">Introduction (Informative)</H2>
<P>This specification describes the mechanism for sending OpenLCB-CAN
information via frames on a CAN segment. 
</P>
<H2 CLASS="western">References and Context (Normative)</H2>
<P>This specification is in the context of the following OpenLCB-CAN
Specifications:</P>
<UL>
	<LI><P>The OpenLCB-CAN Physical Layer specification, which specifies
	the physical layer for transporting OpenLCB CAN frames</P>
	<LI><P>The OpenLCB Node Identifier Specification, which specifies …</P>
</UL>
<P>“CAN” refers to the electrical and protocol specifications as
defined in ISO 11898-1:2003 and ISO 11898-2:2003 and their
successors.</P>
<P>External certification of parts shall be accepted for conformance
to these standards. Conformance with a later version of a standard
shall be accepted as conformance with the referenced versions.</P>
<H2 CLASS="western">Frame Format (Normative)</H2>
<P>OpenLCB-CAN frames are sent and received using the CAN extended
format (29-bit header) only. 
</P>
<P>OpenLCB-CAN nodes shall operate properly when the CAN segment
carries proper standard-format (11-bit header) frames.</P>
<P>OpenLCB-CAN nodes shall not transmit extended-format remote frames
(frames with RTR set). Nodes shall operate properly when the CAN
segment carries proper extended-format remote frames.</P>
<P>OpenLCB-CAN nodes shall not transmit overload frames. Nodes shall
operate properly when the CAN segment carries proper overload frames.</P>
<P STYLE="margin-bottom: 0cm">The first (most-significant) bit is
reserved for future use. It must be transmitted as a 1 bit, and
ignored upon receipt.</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm">The second (second-most-significant)
bit is the Frame Type indicator. A value of 0 indicates a
CAN-specific Control Message. A value of 1 indicates an OpenLCB
Message.</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm">The next 15 bits are termed the
Variable Field. The format and contents of the Variable Field depends
on Frame Type and are defined in later sections.</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm">The last twelve bits (least
significant) are the Source Node ID Alias value.</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<TABLE WIDTH=100% BORDER=1 CELLPADDING=4 CELLSPACING=4>
	<COL WIDTH=64*>
	<COL WIDTH=64*>
	<COL WIDTH=64*>
	<COL WIDTH=64*>
	<TR VALIGN=TOP>
		<TH WIDTH=25%>
			<P>Bit 0</P>
		</TH>
		<TH WIDTH=25%>
			<P>Bits 1</P>
		</TH>
		<TH WIDTH=25%>
			<P>Bits 2-16</P>
		</TH>
		<TH WIDTH=25%>
			<P>Bits 17-28</P>
		</TH>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=25%>
			<P ALIGN=CENTER>Reserved: Send as 1, <BR>ignore upon receipt</P>
		</TD>
		<TD WIDTH=25%>
			<P ALIGN=CENTER>Frame Type:</P>
			<P ALIGN=CENTER>1: OpenLCB Message</P>
			<P ALIGN=CENTER>0: CAN Control Message</P>
		</TD>
		<TD WIDTH=25%>
			<P ALIGN=CENTER>Variable Field</P>
		</TD>
		<TD WIDTH=25%>
			<P ALIGN=CENTER>Source NID Alias</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=25%>
			<P ALIGN=CENTER>0x1000,0000</P>
		</TD>
		<TD WIDTH=25%>
			<P ALIGN=CENTER>0x0800,0000</P>
		</TD>
		<TD WIDTH=25%>
			<P ALIGN=CENTER>0x07FF,F000</P>
		</TD>
		<TD WIDTH=25%>
			<P ALIGN=CENTER>0x0000,0FFF</P>
		</TD>
	</TR>
	<TR VALIGN=TOP>
		<TD WIDTH=25%>
			<P ALIGN=CENTER>Solo top bit</P>
		</TD>
		<TD WIDTH=25%>
			<P ALIGN=CENTER>Top bit of 6<SUP>th</SUP> nibble from right</P>
		</TD>
		<TD WIDTH=25%>
			<P ALIGN=CENTER>3 bits, then three nibbles</P>
		</TD>
		<TD WIDTH=25%>
			<P ALIGN=CENTER>Right-most three nibbles</P>
		</TD>
	</TR>
</TABLE>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P><BR><BR>
</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<H2 CLASS="western">CAN-specific Control Messages and Interactions
(Normative)</H2>
<H3 CLASS="western">States</H3>
<P>A node has two states:</P>
<UL>
	<LI><P>Inhibited</P>
	<LI><P>Permitted</P>
</UL>
<P>Nodes shall start in the Inhibited state.</P>
<P>Nodes shall transition to the Permitted state after assignment of
a valid Node ID alias.</P>
<P>A node may transmit Check ID Message and Reserved ID Message
frames while in the Inhibited state. A node shall not transmit any
other frame while in Inhibited state.</P>
<H3 CLASS="western">Control Message Format</H3>
<P>The format and contents of CAN-specific Control Messages are
defined in the following table:</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<TABLE WIDTH=813 BORDER=1 CELLPADDING=2 CELLSPACING=4>
	<COL WIDTH=331>
	<COL WIDTH=332>
	<COL WIDTH=119>
	<TR>
		<TH WIDTH=331>
			<P>Name</P>
		</TH>
		<TH WIDTH=332>
			<P>Variable Field</P>
		</TH>
		<TH WIDTH=119>
			<P>Data Bytes</P>
		</TH>
	</TR>
	<TR>
		<TD WIDTH=331>
			<P>Check ID (CIM) Message</P>
		</TD>
		<TD WIDTH=332>
			<P>MMM,NNNN,NNNN,NNNN 
			</P>
			<P>where MMM is the message sequence number, with valid values
			from 0x4 through 0x7</P>
			<P>and NNNN,NNNN,NNNN is the 12-bit Node ID section being checked</P>
		</TD>
		<TD WIDTH=119>
			<P>None</P>
		</TD>
	</TR>
	<TR>
		<TD WIDTH=331>
			<P>Reserved ID (RIM) Message</P>
		</TD>
		<TD WIDTH=332>
			<P>0x0700</P>
		</TD>
		<TD WIDTH=119>
			<P>None</P>
		</TD>
	</TR>
	<TR>
		<TD WIDTH=331>
			<P>Mapping Reset (MR) Message</P>
		</TD>
		<TD WIDTH=332>
			<P>0x0701</P>
		</TD>
		<TD WIDTH=119>
			<P>None</P>
		</TD>
	</TR>
	<TR>
		<TD WIDTH=331>
			<P>Mapping Enquiry Request (MRQ) Message</P>
		</TD>
		<TD WIDTH=332>
			<P>0x0702</P>
		</TD>
		<TD WIDTH=119>
			<P>Full Node ID</P>
		</TD>
	</TR>
	<TR>
		<TD WIDTH=331>
			<P>Mapping Enquiry Reply (MRR) Message</P>
		</TD>
		<TD WIDTH=332>
			<P>0x0703</P>
		</TD>
		<TD WIDTH=119>
			<P>Full Node ID</P>
		</TD>
	</TR>
	<TR>
		<TD WIDTH=331>
			<P>Reserved; may not be sent, and must be ignored upon receipt</P>
		</TD>
		<TD WIDTH=332>
			<P>All others</P>
		</TD>
		<TD WIDTH=119>
			<P>To be defined</P>
		</TD>
	</TR>
</TABLE>
<H3 CLASS="western">Interactions</H3>
<H4 CLASS="western">ID Alias assignment</H4>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm">… MMM is the message sequence number,
0x7 to 0x4 (to give priority to messages later in the process) 
</P>
<H4 CLASS="western">ID Alias validation</H4>
<P>A node receiving a Mapping Enquiry Request Message shall compare
the Full Node ID in the CAN data segment to the node's own Node ID.
If and only if they match in length and content and the receiving
node is in Permitted state, the node shall reply with a Mapping
Enquiry Reply Message.</P>
<H4 CLASS="western">ID Alias termination</H4>
<P>A node receiving a Mapping Reset Message must drop the 
</P>
<P><BR><BR>
</P>
<P><BR><BR>
</P>
<P>The common message format uses full 48-bit node ID numbers to
identify originating nodes and in some case destination nodes. CAN
frames use 12-bit local &quot;NID alias&quot; for these to save space
in the limited-size CAN payload. 
</P>
<P>The standard Verify Node ID Number interaction can be used to get
the full 48-bit NID from a node for translation. At power up each
node must obtain a alias that is locally unique. Gateways will also
have to obtain unique aliases for remote nodes they are proxying on
to the segment. 
</P>
<P>Proposed algorithm, in rough form: 
</P>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">Compute a CANid from the NID using
	a standard algorithm. 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">Send CAN frames claiming that
	CANid and carrying sequential parts of NID in the Variable Field
	section of the header. 
	</P>
	<LI><P STYLE="margin-bottom: 0cm">If error, step the algorithm in a
	standard way and repeat until success. 
	</P>
	<LI><P>Send a CAN frame announcing that the node has claimed an ID
	value. 
	</P>
</UL>
<P>Note that there is no requirement that this alias be consistent
from one run to the next. More detail is on a <A HREF="../documents/can/CanIDAllocation.html">separate
page</A>. 
</P>
<P><BR><BR>
</P>
<H3 CLASS="western">CAN-specific messages</H3>
<P>Most CAN frames are one-to-one or many-to-one equivalents of
common OpenLCB messages. 
</P>
<P>A few additional messages are used for CAN-specific purposes. 
</P>
<DL>
	<DT>CIM</DT><DD>
	Check ID Message - used as part of the <A HREF="../documents/can/CanIDAllocation.html">ID
	allocation</A>. 
	</DD><DT>
	RIM</DT><DD>
	Reserved ID Message - used as part of the <A HREF="../documents/can/CanIDAllocation.html">ID
	allocation</A>. 
	</DD><DT>
	MR</DT><DD STYLE="margin-bottom: 0.5cm">
	Mapping Reset - indicates that the local alias in the source address
	field may no longer be associated with the same NID, and mapping
	tables should be reset. 
	</DD></DL>
<H2 CLASS="western">
Translation</H2>
<P>A node must be able to convert traffic on the local CAN segment
into the common message format using only locally available
information. This may be needed e.g. by a gateway or monitoring
program attached to the CAN segment. 
</P>
<P>All traffic on a CAN segment uses aliases for both Source ID
(always) and Destination ID (when the full NID isn't known). 
</P>
<P>If/when a full NID is needed, it can be obtained by sending a
&quot;Verify Node ID Number (Addressed)&quot; message with an
appropriate Destination Node ID in local alias form. The reply will
eventually come back with the Source ID in local alias form and
carrying the full NID in the message content. 
</P>
<P>Aliases for nodes on the local segment are only valid until an
&quot;Initialization Complete&quot; is seen from that alias.
Initialization Complete indicates that a node has restarted, and may
have another local alias. <I>(Can't use Initialization Complete, it's
the wrong layer, need something at the CAN level. Need something like
RIM/CIM)</I></P>
<P>Gateways maintain the mapping between remote node's NID and local
alias. If they need to break that mapping, e.g. because they need to
reuse the local alias due to resource limitations in the mapping
tables, they must send a &quot;Mapping Reset&quot; message to force
nodes to drop their alias information. <I>&quot;Mapping Reset&quot;
is a CAN-specific message limited to the segment, but all gateways on
the segment must act on it.</I> 
</P>
<P>Gateways may not be able ensure permanent validity for alias to
remote NIDs. For example, if they have a limited routing table, they
may need to reuse local alias. Before reusing them, they have to send
a &quot;Mapping Reset&quot; frame to drop references to the old NID,
followed by a &quot;Initialization Complete&quot; when the alias is
allocated to a new NID. 
</P>
<H3 CLASS="western">Map Acquisition</H3>
<P STYLE="margin-bottom: 0cm">In order to acquire the map between
CANids and NIDs, a gateway needs to be able to send a CAN frame
requiring &quot;everybody reply with your NID&quot;. Much like
Ethernet gateway mapping, this needs to return the NID of just the
specific CAN-attached hardware, not all the NIDs that can be e.g.
reached through a gateway, so it needs to be a segment-specific
message defined only at the CAN level. It must not be a OpenLCB
common message. 
</P>
<P STYLE="margin-bottom: 0cm"><I>(Need to add the actual message
definition)</I></P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<H2 CLASS="western">OpenLCB messages in Frames</H2>
<P><I>(provides addressed and global, even though a CAN segment is
intrinsically global; should explain above that OpenLCB is based on
full-global access)</I></P>
<H2 CLASS="western">OpenLCB message format</H2>
<P>OpenLCB common messages are carried in frames with a 1 in the
Frame Type field. They contain message type information and/or
address information in the 15-bit variable field, and zero to eight
CAN data bytes.</P>
<P STYLE="font-style: normal">For OpenLCB messages, the variable
field is used in two forms:</P>
<UL>
	<LI><P STYLE="font-style: normal">Unaddressed messages – messages
	that don't have a destination address put the low 12 bits of the MTI
	in the variable field</P>
</UL>
<DIV ALIGN=RIGHT>
	<TABLE WIDTH=817 BORDER=1 CELLPADDING=4 CELLSPACING=4>
		<COL WIDTH=368>
		<COL WIDTH=419>
		<TR VALIGN=TOP>
			<TH WIDTH=368>
				<P>Variable Field Bit 0</P>
				<P>Header Bit 2</P>
				<P>0x0400,0000</P>
			</TH>
			<TH WIDTH=419>
				<P>Variable Field Bits 1-14</P>
				<P>Header Bits 3-16</P>
				<P>OpenLCB Variable Header Content</P>
				<P>0x03FF,F000</P>
			</TH>
		</TR>
		<TR VALIGN=TOP>
			<TD WIDTH=368 SDVAL="0" SDNUM="1033;">
				<P ALIGN=CENTER>0</P>
			</TD>
			<TD WIDTH=419>
				<P ALIGN=CENTER>OpenLCB message information</P>
			</TD>
		</TR>
	</TABLE>
</DIV>
<P><BR><BR>
</P>
<UL>
	<LI><P STYLE="font-style: normal">Addressed messages – messages
	that have a specific destination address put it in the variable
	field, and carry the MTI in the payload. This allows filtering.</P>
</UL>
<DIV ALIGN=RIGHT>
	<TABLE WIDTH=817 BORDER=1 CELLPADDING=4 CELLSPACING=4>
		<COL WIDTH=223>
		<COL WIDTH=278>
		<COL WIDTH=274>
		<TR VALIGN=TOP>
			<TH WIDTH=223>
				<P>Variable Field Bit 0</P>
				<P>Header Bit 2</P>
				<P>0x0400,0000</P>
			</TH>
			<TH WIDTH=278>
				<P>Variable Field Bits 1-2</P>
				<P>Header Bits 3-4</P>
				<P>OpenLCB Variable Header Content</P>
				<P>0x0300,0000</P>
			</TH>
			<TH WIDTH=274>
				<P>Variable Field Bits 3-14</P>
				<P>Header Bits 5-16</P>
				<P>OpenLCB Variable Header Content</P>
				<P>0x00FF,F000</P>
			</TH>
		</TR>
		<TR VALIGN=TOP>
			<TD WIDTH=223 SDVAL="1" SDNUM="1033;">
				<P ALIGN=CENTER>1</P>
			</TD>
			<TD WIDTH=278>
				<P ALIGN=CENTER>OpenLCB message information</P>
			</TD>
			<TD WIDTH=274>
				<P ALIGN=CENTER>Destination Node ID Alias</P>
			</TD>
		</TR>
	</TABLE>
</DIV>
<P><BR><BR>
</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P><BR><BR>
</P>
<H2 CLASS="western">Frame Communications Process</H2>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">Nodes must handle full rate
	messages, specifically including messages not addressed to them.
	(The datagram and stream protocols provide ways for nodes to
	indicate whether or not they have sufficient buffering for the next
	transmission, triggering retries as needed) For long term
	reliability, a node <U>must</U> be able to completely process an
	entire CAN frame in the time it takes to receive the next one, which
	may be as little as 64 bit times, or about 500 microseconds.</P>
	<LI><P></P>
</UL>
<P STYLE="margin-bottom: 0cm">Discuss the use of repeaters, bridges
and gateways w.r.t. Timing; ref physical layer. Possibility of
reordering.</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm">Over<FONT FACE="Times New Roman, serif"><FONT SIZE=3>load
frame: “</FONT></FONT><FONT COLOR="#000000"><FONT FACE="Times New Roman, serif"><FONT SIZE=3>Due
to internal conditions, the node is not yet able to begin reception
of the next message. A node may generate a maximum of two sequential
overload frames to delay the start of the next message.” (That's 17
to 23 extra bit times each) (from
<A HREF="http://rs232-rs485.blogspot.com/2009/11/can-bus-message-frames-overload.html">http://rs232-rs485.blogspot.com/2009/11/can-bus-message-frames-overload.html</A>)
Image:
<A HREF="http://3.bp.blogspot.com/_ycHwJEosotY/SvoMDJMGF7I/AAAAAAAAA64/3Ql4_UQnoBg/s1600/Overload%2BFrame.JPG">http://3.bp.blogspot.com/_ycHwJEosotY/SvoMDJMGF7I/AAAAAAAAA64/3Ql4_UQnoBg/s1600/Overload%2BFrame.JPG</A></FONT></FONT></FONT></P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<H2 CLASS="western">Link State (Normative)</H2>
<P><BR><BR>
</P>
<P STYLE="margin-bottom: 0cm">(needs a diagram in the explanation
doc)</P>
<H2 CLASS="western"><BR><BR>
</H2>
<H2 CLASS="western">Node ID Alias Generation</H2>
<P><BR><BR>
</P>
<HR>
<P>Site hosted by <FONT COLOR="#000080">
<A HREF="http://sourceforge.net/projects/openlcb"><FONT COLOR="#000080"><IMG SRC="http://sflogo.sourceforge.net/sflogo.php?group_id=286373&amp;type=13" NAME="graphics1" ALIGN=ABSMIDDLE WIDTH=120 HEIGHT=30 BORDER=2></FONT></A></FONT>
</P>
<P>This is SVN $Revision$ 
</P>
</BODY>
</HTML>