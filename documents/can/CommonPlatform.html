<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<META HTTP-EQUIV="CONTENT-TYPE" CONTENT="text/html; charset=utf-8">
	<TITLE>OpenLCB: CAN Wire Protocol</TITLE>
	<META NAME="GENERATOR" CONTENT="OpenOffice.org 3.2  (Unix)">
	<META NAME="CREATED" CONTENT="0;0">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<META NAME="CHANGED" CONTENT="20100721;19105500">
	<META NAME="Info 1" CONTENT="">
	<META NAME="Info 2" CONTENT="">
	<META NAME="Info 3" CONTENT="">
	<META NAME="Info 4" CONTENT="">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
	<META NAME="CHANGEDBY" CONTENT="Bob Jacobsen">
</HEAD>
<BODY LANG="en-US" DIR="LTR">
<H1>Common CAN Platform</H1>
<P>At the NMRA 2010 meeting in Milwaukee, it was tentatively agreed
to work toward a “common platform” definition that manufacturers
could use to create boards with reduced uncertainty as to whether
they'd be usable in the future. This document is the OpenLCB part of
that effort.</P>
<H2>Communications Physical Layer</H2>
<P>All groups have chosen Controller Area Network (CAN, reference
e.g. ISO 11898-2:2003) at 125kbps as a communications fabric. This
rate was generally chosen to be 125kbps to balance length and loading
(see the <A HREF="Background.html">CAN background document</A>).</P>
<P>A common platform standard should require support for that,
including proper slew-rate limitation.</P>
<UL>
	<LI><P STYLE="margin-bottom: 0cm">The rise/fall time of CAN signals
	is a controllable parameter. The MCP2551 transceiver part used in
	e.g. MERG CBUS controls this with an Rs external resistor, by
	default a zero-Ohm jumper. According to Figure 1-1 of the MCP2551
	datasheet, this corresponds to a slope of above 25V/usec. Mike
	Bolton recommended in September 2009 that future designs use a 100k
	resistor instead to give a better waveform shape at 125kbps by
	limiting the slope to just under 5V/usec. This effects the maximum
	possible stub connection length, see SLLA270 page 9. We agree with
	this decision. That should be part of the final OpenLCB-CAN
	specification, along with suitable +/- limits on the quantity.</P>
</UL>
<P>CAN requires cable termination, but there doesn't seem to be a
need to require any particular kind of termination beyond considering
it when deciding on connectors.</P>
<P>CAN does not specify cabling, connectors, grounding nor power. 
The first three are so intimately connected that we consider them
together below, followed by power considerations.</P>
<H3>Cabling, Connectors and Grounding.</H3>
<P>Full length CAN runs require twisted pair cabling.  At all
lengths, the polarity matters.  
</P>
<UL>
	<UL>
		<LI><P STYLE="margin-bottom: 0cm">CBUS uses a wiring
		recommendation, instead of specifying a connector. The 2009 CBUS
		cards use a captive-screw connector, allowing connection of
		CANH/CANL, ground, and several different power voltages. A
		recommendation is emerging to use the center pair of CAT5 cable
		(blue for CANH, white/blue for CANL). Ground is generally needed to
		avoid excessive common-mode voltage.</P>
		<LI><P STYLE="margin-bottom: 0cm">LEDuino rev B/C has a 4 pin
		header, carrying +5V, CanH, CanL, Ground (later versions might
		change this). 
		</P>
		<P STYLE="margin-bottom: 0cm"></P>
	</UL>
</UL>
<P>The polarity requirement immediately rules out the use of the flat
telephone cables commonly found in existing layout control buses:
Flat telephone cable isn't twisted, and can be either cross-over or
straight-through (which causes much confusion due to different
requirements of different DCC vendors). Use of RJ25/RJ14/RJ11 plugs
makes it much too easy to use those kinds of cables, which rules out
those plugs.</P>
<P>There seem to be two primary approaches to wiring:</P>
<H4>Ad-hoc wiring and terminal strips</H4>
<P>Model railroaders are generally used to connecting wires with
terminal strips, and a 3-wire or 4-wire (see power section) terminal
block on the board could be used for CAN.</P>
<P>To get long CAN buses, though, twisted pair wiring with the proper
impedance must be used, and that is not always available in bulk at
the local store.  Hand-twisted wire is very unlikely to be the proper
impedance, which will reduce the length and number of nodes which
work reliably.  And the connectors are certainly not the proper
impedance, which means that each node has a larger impact on the bus
&amp; reduces the number of nodes that can work reliably.</P>
<H4>RJ45 connectors and associated cables</H4>
<P>RJ45 connectors and twisted pair cables are another choice. These
are sometimes called “Ethernet”, “Cat-5” or other names; CAN
only needs Cat-3, so we'll call these “Ethernet cables” here.</P>
<P>Ethernet cables and connectors have the proper impedance and
minimal loss for both the cable and connectors. They are the best way
to ensure that model railroaders routinely can build full-length CAN
buses.  
</P>
<P>Pre-made “Ethernet” cables are quite cheap. Five foot ones are
now available in single quantity for less than $1.50; 25 foot ones
for less than $5 in single quantity. The board connectors are about
$0.70 each, which does add some cost, but must be compared to cost of
other connectors. 
</P>
<P>On the other hand, adding connectors to Ethernet cable (e.g.
making your own from bulk cable) requires special tools and some
skill.  It's easy to mess that up.  
</P>
<P>RJ45 jacks can carry four pair (usually orange, blue, green and
brown; there are two common ways of connecting wires to pins). Many
cheap Ethernet cables contain only the green and orange pairs,
connected to pins 1,2 and 3,6 (with two different color codes).  The
CBUS choice of the blue (center) pair makes it difficult to combine a
“RJ45” and “terminal block” recommendation, as not all
Ethernet cables contain it.  The existance of two different color
codes in the cables also adds confusion, because a decision to use a
specific pair (e.g. 1,2 or 3,6) might result in either green or
orange being the right colors at the other end.</P>
<H3>Power</H3>
<P>Long CAN buses require that boards have some common system ground,
at least for the CAN receivers, to avoid excessive common mode.  It
seems most reliable to carry that in the CAN cable as a 3<SUP>rd</SUP>
conductor. 
</P>
<P>(Should say some words about isolating that ground from other
parts of the system, e.g. the use of isolation in the CAN receivers?)</P>
<P STYLE="font-style: normal">CAN isolation generally requires power
in the CAN bus.  It's also convenient to carry board power, if not
load power, in the cable.  Doing this in a standard requires
specifying a voltage range, and a current limit, in terms that are
useful to a model railroader.</P>
<UL>
	<UL>
		<LI><P STYLE="margin-bottom: 0cm; font-style: normal">CAT5e
		connectors are limited to 1.5A (some are 1A), but the 24ga wire is
		the bigger problem for power distribution as it's 0.0480 ohms per
		foot, or 1 volt drop per 20 feet (one way) at 1A. Use three wires
		ground, three wires power to reduce drop? On board power convertors
		from a higher AC voltage?</P>
	</UL>
</UL>
<P STYLE="margin-bottom: 0cm"><BR>
</P>
<H2>Board Characteristics</H2>
<P>Boards should have a bootloader so that users can load new code
without custom hardware tools. This might be either over a USB
connection (if the board has one; it's not required that the board
does) or over CAN. Since different CPU vendors are likely to provide
different boot-loaders, there's little point in trying to define a
common one. It would be good if CAN-based boot-loaders could be used
without uncabling the board, either by use of jumpers or some form of
addressing (button push?) and non-interfering CAN frames (standard
header?).</P>
<P>There are too many CPU families and specific chips out there to
say anything specific about memory sizes and CPU speeds. It wouldn't
hurt to remind manufacturers that a few pennies spent on either a CPU
socket or extra flash/RAM/EEPROM may extend the useful live of the
product.</P>
<P>Different proposals have different basic I/O needs.  For example,
it would be better to have two LEDs and two buttons (plus reset) for
OpenLCB, while CBUS would prefer one button (reset?) and an 8-wide
DIP switch.  (Have S9.5 schematics been posted anywhere?) Could a
least common denominator approach work here, with boards recommended
to have all these patterned on the board, and selectively stuffed as
needed? Or is that just trying to be too tricky?</P>
<HR>
<P>Site hosted by <FONT COLOR="#000080">
<A HREF="http://sourceforge.net/projects/openlcb"><FONT COLOR="#000080"><IMG SRC="http://sflogo.sourceforge.net/sflogo.php?group_id=286373&amp;type=13" NAME="graphics1" ALIGN=ABSMIDDLE WIDTH=120 HEIGHT=30 BORDER=2></FONT></A></FONT>
</P>
<P>This is SVN $Revision$ 
</P>
</BODY>
</HTML>